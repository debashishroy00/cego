<!-- CEGO Testing Dashboard -->
<mat-toolbar color="primary">
  <mat-icon>analytics</mat-icon>
  <span style="margin-left: 8px;">CEGO Testing Dashboard</span>
  <span class="spacer"></span>
  <mat-chip [color]="backendUp ? 'accent' : 'warn'" selected>
    <mat-icon>{{ backendUp ? 'check_circle' : 'error' }}</mat-icon>
    {{ backendUp ? 'API Connected' : 'API Disconnected' }}
  </mat-chip>
</mat-toolbar>

<div class="dashboard-container">
  <!-- Input Section -->
  <mat-card class="input-section">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>input</mat-icon>
        Query & Context Input
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Scenario Selection -->
      <div class="scenario-section">
        <h3>Predefined Scenarios</h3>
        <div class="scenario-chips">
          <mat-chip-listbox>
            <mat-chip-option
              *ngFor="let scenario of scenarios"
              [selected]="selectedScenario?.id === scenario.id"
              (selectionChange)="loadScenario(scenario)">
              {{scenario.name}}
            </mat-chip-option>
          </mat-chip-listbox>
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- Query Input -->
      <mat-form-field class="full-width">
        <mat-label>Search Query</mat-label>
        <input matInput [(ngModel)]="query" placeholder="Enter your search query">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <!-- Context Input -->
      <mat-form-field class="full-width">
        <mat-label>Context Content (one chunk per line)</mat-label>
        <textarea matInput [(ngModel)]="inputText" rows="8"
                  placeholder="Paste your context chunks here, one per line"></textarea>
        <mat-icon matSuffix>description</mat-icon>
      </mat-form-field>

      <!-- Max Tokens -->
      <mat-form-field class="token-input">
        <mat-label>Max Tokens</mat-label>
        <input matInput type="number" [(ngModel)]="maxTokens" min="100" max="10000">
        <mat-icon matSuffix>tune</mat-icon>
      </mat-form-field>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button mat-raised-button color="primary"
                [disabled]="!backendUp || loading || !query || !inputText"
                (click)="runOptimization()">
          <mat-icon>play_arrow</mat-icon>
          {{ backendUp ? 'Run Optimization' : 'Backend Unavailable' }}
        </button>
        <button mat-button (click)="clearResults()" [disabled]="loading">
          <mat-icon>clear</mat-icon>
          Clear Results
        </button>
      </div>

      <!-- Loading Progress -->
      <mat-progress-bar *ngIf="loading" mode="indeterminate" class="loading-bar"></mat-progress-bar>

      <!-- Error Display -->
      <mat-card *ngIf="errorMsg" class="error-card">
        <mat-card-content>
          <mat-icon color="warn">error</mat-icon>
          <span>{{ errorMsg }}</span>
        </mat-card-content>
      </mat-card>
    </mat-card-content>
  </mat-card>

  <!-- Results Section -->
  <div class="results-section" *ngIf="patternRecognitionResult || entropyResult">

    <!-- Pattern Recognition Results -->
    <mat-card class="result-card" *ngIf="patternRecognitionResult">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>flash_on</mat-icon>
          Pattern Recognition Optimization
        </mat-card-title>
        <mat-card-subtitle>
          Phase 1: Advanced duplicate removal and similarity filtering
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <!-- Error Display for Pattern Recognition -->
        <div *ngIf="hasPatternError" class="error-display">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ patternErrorMsg }}</span>
        </div>
        <div class="metrics-grid" *ngIf="!hasPatternError">
          <div class="metric">
            <span class="metric-label">Token Reduction</span>
            <span class="metric-value primary">{{ patternPct }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Processing Time</span>
            <span class="metric-value">{{ (patternRecognitionResult?.processing_time_ms || 0) | number:'1.0-1' }}ms</span>
          </div>
        </div>

        <!-- Optimized Content Preview -->
        <mat-card class="content-preview" *ngIf="!hasPatternError">
          <mat-card-header>
            <mat-card-title>Optimized Content ({{ patternChunks.length }} chunks)</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="chunk-list">
              <div *ngFor="let chunk of patternChunks.slice(0, 3); trackBy: trackByIndex" class="chunk-item">
                {{ chunk.length > 100 ? chunk.substring(0, 100) + '...' : chunk }}
              </div>
              <div *ngIf="patternChunks.length > 3" class="more-chunks">
                ... and {{ patternChunks.length - 3 }} more chunks
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </mat-card-content>
    </mat-card>

    <!-- Entropy Results -->
    <mat-card class="result-card" *ngIf="entropyResult">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>science</mat-icon>
          Entropy Optimization
        </mat-card-title>
        <mat-card-subtitle>
          Phase 2: Advanced multi-dimensional entropy analysis
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <!-- Error Display for Entropy -->
        <div *ngIf="hasEntropyError" class="error-display">
          <mat-icon color="warn">error</mat-icon>
          <span>{{ entropyErrorMsg }}</span>
        </div>
        <div class="metrics-grid" *ngIf="!hasEntropyError">
          <div class="metric">
            <span class="metric-label">Token Reduction</span>
            <span class="metric-value accent">{{ entropyPct }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Processing Time</span>
            <span class="metric-value">{{ (entropyResult?.processing_time_ms || 0) | number:'1.0-1' }}ms</span>
          </div>
          <div class="metric">
            <span class="metric-label">Confidence Score</span>
            <span class="metric-value">{{ (entropyConfidence * 100) | number:'1.0-1' }}%</span>
          </div>
          <div class="metric">
            <span class="metric-label">Method Used</span>
            <span class="metric-value">{{ entropyResult?.method_used || 'Entropy' }}</span>
          </div>
        </div>

        <div class="cost-savings" *ngIf="!hasEntropyError">
          <mat-icon>savings</mat-icon>
          <span>Estimated Cost Savings: ${{ calculateCostSavings(entropyPct, entropyResult?.original_count || 0).toFixed(4) }}</span>
        </div>

        <!-- Entropy Analysis -->
        <mat-card class="entropy-analysis" *ngIf="entropyResult?.entropy_analysis && !hasEntropyError">
          <mat-card-header>
            <mat-card-title>Entropy Analysis</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="entropy-metrics">
              <div class="entropy-item">
                <span>Total Entropy:</span>
                <span>{{ entropyResult?.entropy_analysis?.total_entropy?.toFixed(2) || 'N/A' }}</span>
              </div>
              <div *ngFor="let entropy of entropyDimensionEntries" class="entropy-item">
                <span>{{ entropy[0] }}:</span>
                <span>{{ entropy[1] | number:'1.2-2' }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Optimized Content Preview -->
        <mat-card class="content-preview" *ngIf="!hasEntropyError">
          <mat-card-header>
            <mat-card-title>Optimized Content ({{ entropyChunks.length }} chunks)</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <ng-container *ngIf="entropyChunks.length; else noEntropyChunks">
              <div class="chunk-list">
                <div *ngFor="let chunk of entropyChunks.slice(0, 3); trackBy: trackByIndex" class="chunk-item">
                  {{ chunk.length > 100 ? chunk.substring(0, 100) + '...' : chunk }}
                </div>
                <div *ngIf="entropyChunks.length > 3" class="more-chunks">
                  ... and {{ entropyChunks.length - 3 }} more chunks
                </div>
              </div>
            </ng-container>
            <ng-template #noEntropyChunks>
              <div class="muted">No optimized chunks.</div>
            </ng-template>
          </mat-card-content>
        </mat-card>
      </mat-card-content>
    </mat-card>

    <!-- Comparison Card -->
    <mat-card class="comparison-card" *ngIf="comparisonResult">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>compare_arrows</mat-icon>
          Algorithm Comparison
        </mat-card-title>
        <mat-card-subtitle>
          Performance comparison between Pattern Recognition and Entropy optimization
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="comparison-metrics">
          <div class="comparison-item">
            <span class="comparison-label">Improvement:</span>
            <span class="comparison-value" [class.positive]="comparisonResult.improvement > 0"
                  [class.negative]="comparisonResult.improvement < 0">
              {{ comparisonResult.improvement > 0 ? '+' : '' }}{{ comparisonResult.improvement.toFixed(2) }}%
            </span>
          </div>
          <div class="comparison-summary">
            <span *ngIf="comparisonResult.improvement > 0">
              üéâ Entropy optimization achieved {{ comparisonResult.improvement.toFixed(1) }}% better token reduction!
            </span>
            <span *ngIf="comparisonResult.improvement === 0">
              ‚öñÔ∏è Both algorithms achieved the same level of optimization.
            </span>
            <span *ngIf="comparisonResult.improvement < 0">
              ‚ö° Pattern Recognition performed better by {{ abs(comparisonResult.improvement).toFixed(1) }}% in this case.
            </span>
          </div>
        </div>

        <!-- Export Button -->
        <div class="export-section">
          <button mat-stroked-button (click)="exportResults()">
            <mat-icon>file_download</mat-icon>
            Export Results
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>